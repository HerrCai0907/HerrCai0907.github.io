# 迈向 wasm2.0

自从 wasm 1.0 发布后数年的迭代，目前越来越多的 wasm 运行时开始支持了 wasm 2.0 的新特性。本文尝试整理 wasm2.0 的新特性，探讨这些新特性可以为开发和执行带来哪些改善。

## merged features

### Sign extension instruction

该提案增加了五条新的整数指令，用于对 8 位、16 位和 32 位值进行符号扩展。

#### 前端编译器

wasm 原生支持的整数类型仅包含 i32 和 i64，而绝大多数编程语言都支持 8 位，16 位的整数类型，缺乏对 8/16 位整数类型的符号扩展导致许多计算过程中的隐式类型转换需要生成 4 条 wasm 指令(const, shl, const, shr_s)。

e.g.

```c++
signed char f(signed char a, signed char b) {
    return a + b;
}
```

before

```wasm
f(signed char, signed char):                                 # @f(signed char, signed char)
        local.get       1
        local.get       0
        i32.add
        i32.const       24
        i32.shl
        i32.const       24
        i32.shr_s
        end_function
```

after

```wasm
f(signed char, signed char):                                 # @f(signed char, signed char)
        local.get       1
        local.get       0
        i32.add
        i32.extend8_s
        end_function
```

#### JIT 编译器

由于绝大多数现代指令集均支持通过一条指令直接进行符号扩展，增加这组指令有助于提高 wasm 的执行效率。

### Non-trapping float-to-int conversions

该提案增加了 8 条指令用于不导致 trap 的情况下将浮点数转化为整数。

- 当浮点数转化为整数过程中发生 overflow 时，该组指令不发生 trap，而是返回最大或者最小值
- 当浮点数为 NaN 时，该组指令不发生 trap，而是返回 0

#### 前端编译器

LLVM 中，当浮点数转化为整数发生 overflow 时，并不是一个未定义行为，而是返回一个未定义值。并且 LLVM 中端优化器基于这一特性进行了优化，直接将 llvm ir 发射到 wasm 时，语义到不兼容将导致一些隐性 bug。使用检查将会降低生成代码的性能。

```c++
int f(float a) {
    return (int)a;
}
```

before

```wasm
f(float):                                  # @f(float)
        block
        local.get       0
        f32.abs
        f32.const       0x1p31
        f32.lt
        i32.eqz
        br_if           0                               # 0: down to label0
        local.get       0
        i32.trunc_f32_s
        return
        end_block                               # label0:
        i32.const       -2147483648
        end_function
```

after

```wasm
f(float):                                  # @f(float)
        local.get       0
        i32.trunc_sat_f32_s
        end_function
```

#### JIT 编译器

ARM 指令集行为与提案一致.
x86 指令集在所有异常情况下返回最小值。
Power 指令集行为与提案一致，除了`NaN`将会转化为最小整数。
RISC-V 指令集行为与提案一致，除了`NaN`将会转化为最大整数。

### Multiple values

该提案允许函数类型中出现多个返回值类型

- 将函数返回值中的元祖进行拆包，从而高效的编译多个返回值类型
- 允许 block / loop / if 使用参数

### Reference types

### Table instructions

### Multiple

### Bulk memory and table instructions

### Vector instructions

TODO!
