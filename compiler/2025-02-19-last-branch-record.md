# 最后分支记录

如果可以记录所有的分支跳转, 那么我们就可以重建程序的分支跳转。

## Intel ( Last Branch Record)

Intel Last Branch Record (LBR) 是处理器硬件级调试功能, 用于记录程序执行过程中最近的分支跳转信息。其核心原理是通过专用寄存器 (LBR Stack) 存储分支指令的源地址、目标地址及元数据 (如分支类型) , 为开发者提供精准的执行流追踪能力。

LBR主要服务于性能分析与调试场景。在性能优化中, 结合perf或VTune等工具, LBR可快速定位代码热点、分支预测失效或流水线停滞问题, 辅助实现低延迟、高吞吐的代码设计。安全领域则利用LBR监控异常控制流, 例如检测Spectre漏洞攻击中的越界分支行为。

相较于软件插桩, LBR的优势在于硬件级低开销 (通常<5%性能损耗) 和高精度。从Nehalem架构开始, Intel逐步扩展LBR能力, 新增对特权级切换、中断事件的记录支持。当前, LBR已成为实时性能剖析与高级漏洞分析的关键基础设施, 在云计算、金融交易等对延迟敏感的场景中发挥核心作用。

## AArch64 (Branch Record Buffer Extension)

AArch64架构的Branch Record Buffer (BRB) 是ARMv8.4引入的硬件级调试功能, 用于捕获处理器最近执行的分支指令轨迹。通过专用寄存器组 (如BRBIDR/BRBINF) 记录分支源地址、目标地址及元数据 (如分支类型) , LBR为开发者提供低开销的运行时控制流追踪能力。

与Intel LBR类似, 该技术主要用于性能优化与安全分析。在性能调优中, 结合Linux perf或DS-5工具链, 开发者可定位分支预测失效、指令缓存争用等问题, 优化关键路径代码。安全领域则通过监控非预期分支 (如ROP攻击链) 增强系统防护。

AArch64 LBR的独特设计在于其对复杂微架构 (如Cortex-X系列) 的适配能力, 支持可配置的记录深度 (4至32条分支) 与多级过滤 (仅记录用户态/内核态分支) 。相较于软件插桩, 其硬件级实现的开销可忽略 (<1%) , 并兼容Arm SPE (Statistical Profiling Extension) 实现更细粒度的性能剖析。目前, LBR已成为移动端及服务器场景中实时诊断与高精度性能分析的核心工具。

以下是AArch64架构下Branch Record Buffer (BRB) 相关核心寄存器的功能概览表：

| 寄存器名称 | 功能描述                                                                 | 访问权限 |
| ---------- | ------------------------------------------------------------------------ | -------- |
| BRBIDR     | BRB实现信息寄存器, 包含BRB硬件实现特性 (如最大记录深度、支持的功能等)    | RO, EL1+ |
| BRBCR      | BRB控制寄存器, 配置全局使能、记录模式 (循环/停止溢出) 及中断触发条件     | RW, EL1+ |
| BRBFCR     | BRB过滤控制寄存器, 设置分支类型过滤 (如仅记录用户态/内核态/特定分支类型) | RW, EL1+ |
| BRBINF\<n> | BRB条目信息寄存器组 (n=0-31) , 存储每条分支记录的元数据 (如有效位、类型) | RW, EL1+ |
| BRBSRC\<n> | BRB源地址寄存器组 (n=0-31) , 记录分支指令的源地址                        | RO, EL1+ |
| BRBTGT\<n> | BRB目标地址寄存器组 (n=0-31) , 记录分支指令的目标地址                    | RO, EL1+ |
| BRBTS      | BRB时间戳寄存器, 记录分支事件的时间戳 (需硬件支持)                       | RO, EL1+ |

- 说明：

索引范围: \<n>表示寄存器组索引, 实际数量由BRBIDR中定义的BRB深度决定 (如支持32条记录时n=0-31).
特权级要求：访问BRB寄存器通常需在EL1 (内核态) 或更高特权级, 部分实现可能依赖EL2虚拟化扩展.
依赖条件: BRB功能需要处理器支持ARMv8.4+架构及BRB扩展 (通过ID_AA64DFR0_EL1.BRB字段确认).
